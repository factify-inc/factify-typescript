name: Generate TypeScript SDK
permissions:
  checks: write
  contents: write
  pull-requests: write
  statuses: write
  id-token: write
on:
  workflow_dispatch:
    inputs:
      force:
        description: Force generation of SDK
        type: boolean
        default: false
      set_version:
        description: optionally set a specific SDK version
        type: string
      test_failure_notification:
        description: 'Test failure notification (skip actual generation)'
        type: boolean
        default: false
  repository_dispatch:
    types: [openapi-update]
  schedule:
    - cron: 0 0 * * *
jobs:
  generate:
    uses: speakeasy-api/sdk-generation-action/.github/workflows/workflow-executor.yaml@v15
    if: ${{ !inputs.test_failure_notification }}
    with:
      force: ${{ github.event.inputs.force || false }}
      mode: direct
      set_version: ${{ github.event.inputs.set_version }}
      target: typescript
      publish_with_provenance: true
    secrets:
      github_access_token: ${{ secrets.SDK_PUBLISH_GH_TOKEN }}
      speakeasy_api_key: ${{ secrets.SPEAKEASY_API_KEY }}

  notify-failure:
    name: Send Slack failure notification
    needs: generate
    runs-on: ubuntu-latest
    if: failure() || inputs.test_failure_notification
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Prepare failure notification payload
        id: prepare-failure-message
        shell: bash
        run: |
          # Use test inputs if provided, otherwise use actual workflow values
          if [ "${{ inputs.test_failure_notification }}" == "true" ]; then
            SDK_NAME="TypeScript"
            REPO="factify-inc/factify-typescript"
            COMMIT_SHA="${{ github.sha }}"
            RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            RUN_NUM="${{ github.run_number }}"
          else
            SDK_NAME="TypeScript"
            REPO="factify-inc/factify-typescript"
            COMMIT_SHA="${{ github.sha }}"
            RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            RUN_NUM="${{ github.run_number }}"
          fi
          
          # Build the entire JSON payload using jq to properly escape everything
          PAYLOAD=$(jq -n \
            --arg sdk "$SDK_NAME" \
            --arg repo "$REPO" \
            --arg commit "$COMMIT_SHA" \
            --arg runUrl "$RUN_URL" \
            --arg runNum "$RUN_NUM" \
            '{text: "‚ùå *SDK Generation Failed (Run #\($runNum))*\n\n*SDK:* \($sdk)\n*Repository:* <https://github.com/\($repo)|\($repo)>\n*Commit:* <https://github.com/\($repo)/commit/\($commit)|View commit>\n*Workflow Run:* <\($runUrl)|View Run>"}')

          echo "payload<<EOF" >> $GITHUB_OUTPUT
          echo "$PAYLOAD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # For testing: show the payload
          echo "=== Generated Payload ==="
          echo "$PAYLOAD" | jq .

      # TESTING: Comment out actual Slack sending, uncomment to test real notifications
      # - name: Send Slack failure notification
      #   uses: ./.github/actions/slack-sdk-failure
      #   with:
      #     webhook-url: ${{ secrets.FACTOPS_PROD_RELEASE_SLACK_URL }}
      #     sdk-name: "TypeScript"
      #     repository: "factify-inc/factify-typescript"
      #     workflow-run-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      #     commit-sha: ${{ github.sha }}
      #     run-number: ${{ github.run_number }}
      
      - name: Show payload (testing only)
        run: |
          echo "Payload that would be sent:"
          echo "${{ steps.prepare-failure-message.outputs.payload }}" | jq .
